# ä½¿ç”¨blazor servers å’Œsignalrå®ç°ç®€å•çš„åœ¨çº¿äº”å­æ£‹æ¸¸æˆ
 å‰äº›å¤©å¥³æœ‹å‹é‚€è¯·æˆ‘ä¸€èµ·ç©å¾®ä¿¡å°ç¨‹åºé‡Œçš„æŸä¸ªäº”å­æ£‹æ¸¸æˆ,ç»å¸¸è¿›ä¸å»æˆ¿é—´ä¸”å¹¿å‘Šæå¤š,ä»¤äººç”ŸåŒ.äºæ˜¯å°±æœ‰äº†è¿™ä¸ªç»ƒæ‰‹å°é¡¹ç›®

 [githubä»“åº“åœ°å€](https://github.com/zfyzmh/BlazorGame)

![alt text](image/image.png)

## å€Ÿé‰´åŠå¼•ç”¨å†…å®¹

[é˜¿æ˜Ÿplusåšå®¢](https://docs.meowv.com/stack/blazor/gomoku-games-based-on-blazor.html)

## [äº”å­æ£‹å•æœºéƒ¨åˆ†ä»£ç å®ç°ä»“åº“åœ°å€](https://github.com/ut32/gobang/)

## å‘ç‚¹

1. å‰ªè´´æ¿å‡½æ•°å¿…é¡»æ˜¯httpsæˆ–è€…æœ¬åœ°æ‰å¯ä»¥è°ƒç”¨

2. text.jsonæ— æ³•è§£æäºŒç»´æ•°ç»„,éœ€åˆ‡æ¢json.net

3. signalræ›´æ–°æ•°æ®åæ— æ³•åŠæ—¶åˆ·æ–°é¡µé¢ è§£å†³æ–¹æ³•ä¸º StateHasChanged() æ”¹ä¸º InvokeAsync(StateHasChanged);æœ‰ç‚¹winformä¸­this.invokeé‚£å‘³äº†

4. appsettings.jsonä¸­æˆ–appsettings.Development.jsonä¸­éœ€æ·»åŠ "DetailedErrors": trueä»¥æ˜¾ç¤ºè¯¦ç»†çš„é”™è¯¯ä¿¡æ¯,å‰ªåˆ‡æ¿æŠ¥é”™æ—¶æç¤ºæˆ‘åšçš„

## ä¸»è¦ä»£ç 

### Program.cs

```c#
using Gobang.GameHub;
using Microsoft.AspNetCore.Components;
using Microsoft.AspNetCore.Components.Web;
using MudBlazor.Services;

namespace Gobang
{
    public class Program
    {
        public static void Main(string[] args)
        {
            var builder = WebApplication.CreateBuilder(args);

            // Add services to the container.

            builder.Services.AddSignalR()
                .AddNewtonsoftJsonProtocol();
            builder.Services.AddRazorPages();
            builder.Services.AddServerSideBlazor();

            builder.Services.AddMudServices();
            builder.WebHost.UseUrls("http://*:5005");

            var app = builder.Build();

            // Configure the HTTP request pipeline.
            if (!app.Environment.IsDevelopment())
            {
                app.UseExceptionHandler("/Error");
            }

            app.UseStaticFiles();

            app.UseRouting();

            app.MapBlazorHub();
            app.MapFallbackToPage("/_Host");
            app.MapHub<BlazorChatSampleHub>(BlazorChatSampleHub.HubUrl);
            app.MapHub<GoBangHub>(GoBangHub.HubUrl);

            app.Run();
        }
    }
} 
```
### GoBangHub.cs(signalré›†çº¿å™¨)
``` c#
using Gobang.Model;
using Microsoft.AspNetCore.SignalR;
using Microsoft.Extensions.Caching.Memory;

namespace Gobang.GameHub
{
    public class GoBangHub : Hub
    {
        public const string HubUrl = "/gobang";

        private static readonly List<GoBangRoom> goBangRooms = new();

        public override Task OnConnectedAsync()
        {
            Console.WriteLine($"{Context.ConnectionId} connected");
            return base.OnConnectedAsync();
        }

        public override async Task OnDisconnectedAsync(Exception? exception)
        {
            Console.WriteLine($"Disconnected {exception?.Message} {Context.ConnectionId}");
            await base.OnDisconnectedAsync(exception);
        }

        /// <summary>
        /// åˆ›å»ºæˆ¿é—´(å³åˆ›å»ºç¾¤ç»„)
        /// </summary>
        /// <param name="roomName">æˆ¿é—´å(ç¾¤ç»„å)</param>
        /// <param name="password">å¯†ç (å¯é€‰)</param>
        /// <returns></returns>
        public async Task CreateRoom(string roomName, string? password = null)
        {
            goBangRooms.Add(new GoBangRoom() { Guid = Guid.NewGuid(), RoomName = roomName, Password = password });

            await Groups.AddToGroupAsync(Context.ConnectionId, roomName);
        }

        /// <summary>
        /// åŠ å…¥æˆ¿é—´(ç¾¤ç»„)
        /// </summary>
        /// <param name="roomName">æˆ¿é—´å(ç¾¤ç»„å)</param>
        /// <param name="password">å¯†ç (å¯é€‰)</param>
        /// <returns></returns>
        public async Task GetIntoRoom(string roomName, string? password = null)
        {
            var room = goBangRooms.FirstOrDefault(m => m.RoomName == roomName);

            if (room == null)
            {
                await Clients.Caller.SendAsync("Alert", "æœªæ‰¾åˆ°è¯¥æˆ¿é—´!");
                return;
            }
            else
            {
                if (!string.IsNullOrEmpty(room.Password) && room.Password != password)
                {
                    await Clients.Caller.SendAsync("Alert", "æˆ¿é—´å¯†ç é”™è¯¯!");
                    return;
                }
            }

            await Groups.AddToGroupAsync(Context.ConnectionId, roomName);
        }

        /// <summary>
        /// è½å­
        /// </summary>
        /// <param name="room">æˆ¿é—´</param>
        /// <param name="Chess">æ£‹ç›˜</param>
        /// <returns></returns>
        public async Task Playing(GoBangRoom room, int[,] Chess)
        {
            goBangRooms.First(m => m.RoomName == room.RoomName).Chess = Chess;
            await Clients.OthersInGroup(room.RoomName).SendAsync("SynchronizeCheckerboard", Chess);
        }

        public async Task Win(GoBangRoom room)
        {
            await Clients.OthersInGroup(room.RoomName).SendAsync("Alert", "\nä½ ä¸ªæ¸£æ¸£ğŸ‘");
        }
    }
}
```
### Gobang.razor.cs
``` html

@page "/"
@page "/{RoomName}"

@inject IJSRuntime JS

<div class="gobang-box">
    <Gobang.Shared.Chessboard Chess="Chess" OnPlaying="Playing"></Gobang.Shared.Chessboard>
</div>
<div class="chess-info">
    <h1>äº”å­æ£‹âš«âšª</h1>
    @if (!IsInRoom)
    {
        <p><MudButton Variant="Variant.Outlined" Color="Color.Primary" @onclick="CreateRoom">åˆ›å»ºæˆ¿é—´</MudButton></p>
        <p><MudButton Variant="Variant.Outlined" Color="Color.Primary" @onclick="GetIntoRoom">åŠ å…¥æˆ¿é—´</MudButton></p>
    }
    else
    {
        <p><MudButton Variant="Variant.Outlined" Color="Color.Primary" @onclick="StartGame">@(IsInGame ? "é‡ç½®æ¸¸æˆ" : "å¼€å§‹æ¸¸æˆ")</MudButton></p>

        <p><MudButton Variant="Variant.Outlined" Color="Color.Primary" @onclick="Invite">é‚€è¯·æœ‹å‹</MudButton></p>
    }

    <div class="chess-msg">
        <p><b>@msgs</b></p>
        <span>ç¬¬ä¸€æ­¥,åˆ›å»ºæˆ¿é—´</span>
        <span>ç¬¬äºŒæ­¥,ç‚¹å‡»é‚€è¯·æœ‹å‹</span>
        <span>ç¬¬ä¸‰æ­¥,ç­‰æœ‹å‹è¿›å…¥ç½‘é¡µåç‚¹å‡»å¼€å§‹æ¸¸æˆ</span>
        <span>ç¬¬å››æ­¥,è½å­</span>
        <p>æ¸¸æˆè§„åˆ™ï¼š</p>
        <span>ï¼ˆ1ï¼‰æˆ¿ä¸»å§‹ç»ˆé»‘æ£‹å…ˆæ‰‹ã€‚</span>
        <span>ï¼ˆ2ï¼‰ç‚¹å‡»å¼€å§‹æ¸¸æˆæŒ‰é’®å¼€å§‹å¯¹å±€ã€‚</span>
        <span>ï¼ˆ4ï¼‰å¯¹å±€åŒæ–¹å„æ‰§ä¸€è‰²æ£‹å­ã€‚</span>
        <span>ï¼ˆ5ï¼‰ç©ºæ£‹ç›˜å¼€å±€ã€‚</span>
        <span>ï¼ˆ6ï¼‰é»‘å…ˆã€ç™½åï¼Œäº¤æ›¿ä¸‹å­ï¼Œæ¯æ¬¡åªèƒ½ä¸‹ä¸€å­ã€‚</span>
        <span>ï¼ˆ7ï¼‰æ£‹å­ä¸‹åœ¨æ£‹ç›˜çš„ç©ºç™½ç‚¹ä¸Šï¼Œæ£‹å­ä¸‹å®šåï¼Œä¸å¾—å‘å…¶å®ƒç‚¹ç§»åŠ¨ï¼Œä¸å¾—ä»æ£‹ç›˜ä¸Šæ‹¿æ‰æˆ–æ‹¿èµ·å¦è½åˆ«å¤„ã€‚</span>
        <span>ï¼ˆ8ï¼‰é»‘æ–¹çš„ç¬¬ä¸€æšæ£‹å­å¯ä¸‹åœ¨æ£‹ç›˜ä»»æ„äº¤å‰ç‚¹ä¸Šã€‚</span>
        <span>ï¼ˆ9ï¼‰è½®æµä¸‹å­æ˜¯åŒæ–¹çš„æƒåˆ©ï¼Œ<del>ä½†å…è®¸ä»»ä½•ä¸€æ–¹æ”¾å¼ƒä¸‹å­æƒï¼ˆå³ï¼šPASSæƒï¼‰</del>ã€‚</span>
        <span>ï¼ˆ10ï¼‰<del>äº”å­æ£‹å¯¹å±€ï¼Œæ‰§è¡Œé»‘æ–¹æŒ‡å®šå¼€å±€ã€ä¸‰æ‰‹å¯äº¤æ¢ã€äº”æ‰‹ä¸¤æ‰“çš„è§„å®šã€‚æ•´ä¸ªå¯¹å±€è¿‡ç¨‹ä¸­é»‘æ–¹æœ‰ç¦æ‰‹ï¼Œç™½æ–¹æ— ç¦æ‰‹ã€‚é»‘æ–¹ç¦æ‰‹æœ‰ä¸‰ä¸‰ç¦æ‰‹ã€å››å››ç¦æ‰‹å’Œé•¿è¿ç¦æ‰‹ä¸‰ç§ã€‚</del></span>
    </div>
</div>

```

### Gobang.razor.cs
``` c#
using Gobang.GameHub;
using Gobang.Model;
using Microsoft.AspNetCore.Components;
using Microsoft.AspNetCore.SignalR.Client;
using Microsoft.JSInterop;
using MudBlazor;

namespace Gobang.Pages
{
    public partial class Gobang : IDisposable
    {
        [Inject] private NavigationManager? NavigationManager { get; set; }

        [Inject]
        private ISnackbar Snackbar { get; set; }

        [Parameter]
        public string RoomName { get; set; }

        private int[,] Chess { get; set; } = new int[19, 19];

        private string first = "He";

        private bool IsInGame = false;

        private bool IsInRoom = false;

        private GoBangRoom? Room { get; set; }

        private string msgs;

        private int MineChess = 1;

        private string? _hubUrl;
        private HubConnection? _hubConnection;

        protected override async Task OnInitializedAsync()
        {
            if (_hubConnection == null)
            {
                string baseUrl = NavigationManager!.BaseUri;

                _hubUrl = baseUrl.TrimEnd('/') + GoBangHub.HubUrl;

                _hubConnection = new HubConnectionBuilder()
                    .WithUrl(_hubUrl)
                    .ConfigureLogging(logging => logging.AddConsole())
                    .AddNewtonsoftJsonProtocol()
                    .Build();

                _hubConnection.On<int[,]>("SynchronizeCheckerboard", SynchronizeCheckerboard);
                _hubConnection.On<string>("Alert", Alert);
                await _hubConnection.StartAsync();
            }

            await base.OnInitializedAsync();
        }

        protected override async Task OnParametersSetAsync()
        {
            if (!string.IsNullOrEmpty(RoomName))
            {
                IsInRoom = true;
                IsInGame = true;
                MineChess = 2;
                Room = new GoBangRoom() { RoomName = RoomName };
                await _hubConnection!.SendAsync("GetIntoRoom", RoomName, "");
            }
            await base.OnParametersSetAsync();
        }

        private async Task Alert(string msg)
        {
            await JS.InvokeAsync<string>("alert", msg);

            if (msg == "\nä½ ä¸ªæ¸£æ¸£ğŸ‘")
            {
                IsInGame = false;
                Chess = new int[19, 19];
            }
        }

        private async Task CreateRoom()
        {
            var roomname = await JS.InvokeAsync<string>("prompt", "è¯·è¾“å…¥æˆ¿é—´åç§°!", "æˆ¿é—´" + Guid.NewGuid());

            if (string.IsNullOrEmpty(roomname)) return;

            IsInRoom = true;

            MineChess = 1;
            if (string.IsNullOrEmpty(roomname)) return;
            await _hubConnection!.SendAsync("CreateRoom", roomname, "");
            Room = new GoBangRoom() { RoomName = roomname };
        }

        private async Task GetIntoRoom()
        {
            var roomname = await JS.InvokeAsync<string>("prompt", "è¯·è¾“å…¥æˆ¿é—´åç§°!");
            if (string.IsNullOrEmpty(roomname)) return;

            IsInRoom = true;
            IsInGame = true;
            await _hubConnection!.SendAsync("GetIntoRoom", roomname, "");
            MineChess = 2;
            Room = new GoBangRoom() { RoomName = roomname };
        }

        private async Task Invite()
        {
            Snackbar.Add("å¤åˆ¶é“¾æ¥æˆåŠŸ,å¿«å»é‚€è¯·ä½ çš„æœ‹å‹å§!ğŸš€");
            await JS.InvokeVoidAsync("copyToClipboard", NavigationManager.BaseUri + Room!.RoomName);
        }

        private async Task StartGame()
        {
            // åˆå§‹åŒ–æ£‹ç›˜
            Chess = new int[19, 19];

            IsInGame = true;
            await _hubConnection!.SendAsync("Playing", Room, Chess);
        }

        private async Task Playing((int, int) value)
        {
            (int row, int cell) = value;

            var numEqual = Chess.OfType<int>().Count(x => x == 1) == Chess.OfType<int>().Count(x => x == 2);

            if (MineChess == 1)
            {
                if (!numEqual)
                {
                    Snackbar.Add("å¯¹æ–¹è½å­æ—¶é—´!ğŸš€");
                    return;
                }
            }
            else
            {
                if (numEqual)
                {
                    Snackbar.Add("å¯¹æ–¹è½å­æ—¶é—´!ğŸš€");
                    return;
                }
            }

            //æ˜¯å¦å¼€å§‹æ¸¸æˆï¼Œå½“å‰åˆ¤æ–­æ²¡å¼€å§‹ç»™å‡ºæç¤º
            if (!IsInGame)
            {
                Snackbar.Add("\nğŸ’ªç‚¹å‡»å¼€å§‹æ¸¸æˆæŒ‰é’®å¼€å¯å¯¹å±€ï¼Œè¯·é˜…è¯»æ¸¸æˆè§„åˆ™ğŸ’ª");

                return;
            }

            // å·²è½å­ç›´æ¥è¿”å›ï¼Œä¸åšä»»ä½•æ“ä½œ
            if (Chess[row, cell] != 0)
                return;

            // æ ¹æ®ä¼ è¿›æ¥çš„åæ ‡è¿›è¡Œæˆ‘æ–¹è½å­
            Chess[row, cell] = MineChess;

            if (IsWin(MineChess, row, cell))
            {
                await JS.InvokeAsync<Task>("alert", "\næ­å–œï¼Œä½ èµ¢äº†ğŸ‘");

                IsInGame = !IsInGame;
                await _hubConnection!.SendAsync("Win", Room);
            }

            // æˆ‘æ–¹è½å­ä¹‹åé€šçŸ¥å¯¹æ–¹è½å­
            await _hubConnection!.SendAsync("Playing", Room, Chess);
            StateHasChanged();
        }

        private void SynchronizeCheckerboard(int[,] chess)
        {
            Chess = chess;
            InvokeAsync(StateHasChanged);
        }

        private bool IsWin(int chess, int row, int cell)
        {
            #region æ¨ªæ–¹å‘ â¡â¬…

            {
                var i = 1;
                var score = 1;
                var rightValid = true;
                var leftValid = true;

                while (i <= 5)
                {
                    var right = cell + i;
                    if (rightValid && right < 19)
                    {
                        if (Chess[row, right] == chess)
                        {
                            score++;
                            if (score >= 5)
                                return true;
                        }
                        else
                            rightValid = false;
                    }

                    var left = cell - i;
                    if (leftValid && left >= 0)
                    {
                        if (Chess[row, left] == chess)
                        {
                            score++;
                            if (score >= 5)
                                return true;
                        }
                        else
                            leftValid = false;
                    }

                    i++;
                }
            }

            #endregion æ¨ªæ–¹å‘ â¡â¬…

            #region ç«–æ–¹å‘ â¬‡â¬†

            {
                var i = 1;
                var score = 1;
                var topValid = true;
                var bottomValid = true;

                while (i < 5)
                {
                    var top = row - i;
                    if (topValid && top >= 0)
                    {
                        if (Chess[top, cell] == chess)
                        {
                            score++;
                            if (score >= 5)
                                return true;
                        }
                        else
                            topValid = false;
                    }

                    var bottom = row + i;
                    if (bottomValid && bottom < 19)
                    {
                        if (Chess[bottom, cell] == chess)
                        {
                            score++;
                            if (score >= 5)
                                return true;
                        }
                        else
                        {
                            bottomValid = false;
                        }
                    }

                    i++;
                }
            }

            #endregion ç«–æ–¹å‘ â¬‡â¬†

            #region æ’‡æ–¹å‘ â†™â†—

            {
                var i = 1;
                var score = 1;
                var topValid = true;
                var bottomValid = true;

                while (i < 5)
                {
                    var rightTopRow = row - i;
                    var rightTopCell = cell + i;
                    if (topValid && rightTopRow >= 0 && rightTopCell < 19)
                    {
                        if (Chess[rightTopRow, rightTopCell] == chess)
                        {
                            score++;
                            if (score >= 5)
                                return true;
                        }
                        else
                            topValid = false;
                    }

                    var leftBottomRow = row + i;
                    var leftBottomCell = cell - i;
                    if (bottomValid && leftBottomRow < 19 && leftBottomCell >= 0)
                    {
                        if (Chess[leftBottomRow, leftBottomCell] == chess)
                        {
                            score++;
                            if (score >= 5)
                                return true;
                        }
                        else
                            bottomValid = false;
                    }

                    i++;
                }
            }

            #endregion æ’‡æ–¹å‘ â†™â†—

            #region æºæ–¹å‘ â†˜â†–

            {
                var i = 1;
                var score = 1;
                var topValid = true;
                var bottomValid = true;

                while (i < 5)
                {
                    var leftTopRow = row - i;
                    var leftTopCell = cell - i;
                    if (topValid && leftTopRow >= 0 && leftTopCell >= 0)
                    {
                        if (Chess[leftTopRow, leftTopCell] == chess)
                        {
                            score++;
                            if (score >= 5)
                                return true;
                        }
                        else
                            topValid = false;
                    }

                    var rightBottomRow = row + i;
                    var rightBottomCell = cell + i;
                    if (bottomValid && rightBottomRow < 19 && rightBottomCell < 19)
                    {
                        if (Chess[rightBottomRow, rightBottomCell] == chess)
                        {
                            score++;
                            if (score >= 5)
                                return true;
                        }
                        else
                            bottomValid = false;
                    }

                    i++;
                }
            }

            #endregion æºæ–¹å‘ â†˜â†–

            return false;
        }

        public async void Dispose()
        {
            if (_hubConnection != null)
            {
                await _hubConnection.StopAsync();
                await _hubConnection.DisposeAsync();
                _hubConnection = null;
            }
        }
    }
}
```

### Gobang.razor.cs

``` c#

<div class="chess">
    @for (var i = 0; i < 19; i++)
    {
        @for (var j = 0; j < 19; j++)
        {
            var _i = i;
            var _j = j;
            <div class="cell" @onclick="@(async () => await Playing(_i, _j))">
                <span class="chess@(Chess[i, j])"></span>
            </div>
        }
    }
</div>

@code {
    [Parameter] public int[,] Chess { get; set; }
    [Parameter]
    public EventCallback<(int, int)> OnPlaying { get; set; }

    private async Task Playing(int row, int cell)
    {
        if (OnPlaying.HasDelegate)
        {
            await OnPlaying.InvokeAsync((row, cell));
        }
    }
}

```